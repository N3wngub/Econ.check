<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SE Grader AI: Expert Edition (Fixed)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mammoth.js for Docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .animate-enter { animation: enter 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes enter { to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, Component } = React;

        // --- EXPERT KNOWLEDGE BASE ---
        const EXPERT_CONTEXT = `
            บทบาท: ศาสตราจารย์ผู้เชี่ยวชาญ Software Engineering Economics (อ้างอิง Ch06-ECON-68.pdf Burapha Univ.)
            
            **COCOMO Model (Constructive Cost Model)**
            สูตร: Effort (E) = a * (KLOC)^b | Time (T) = c * (E)^d | People (P) = E / T
            
            **ตารางค่าคงที่ (สำคัญที่สุด):**
            1. Organic (ทีมเล็ก/งานง่าย): a=2.4, b=1.05, c=2.5, d=0.38
            2. Semi-detached (ทีมผสม/งานกลาง): a=3.0, b=1.12, c=2.5, d=0.35
            3. Embedded (ซับซ้อนสูง/ข้อจำกัดเยอะ): a=3.6, b=1.20, c=2.5, d=0.32

            **Halstead's Theory**
            N = N1 + N2 | N^ = u1*log2(u1) + u2*log2(u2)

            **คำสั่ง:**
            1. ตรวจสอบประเภทโครงการ (Organic/Semi/Embedded) ว่านิสิตเลือกถูกหรือไม่
            2. ตรวจสอบการแทนค่า a, b, c, d ว่าตรงกับตารางไหม
            3. ตรวจคำนวณ Effort, Time, People
            4. ให้คะแนนเต็ม 100
        `;

        // --- SVG Icons (No external script dependency) ---
        const Icons = {
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Key: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            UploadCloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>,
            Loader2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Lightbulb: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
        };

        // --- Error Boundary to prevent White Screen ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("React Error:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-6 text-center">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg">
                                <h2 className="text-2xl font-bold text-red-600 mb-4">ขออภัย เกิดข้อผิดพลาด</h2>
                                <p className="text-gray-600 mb-4">ระบบพบปัญหาในการแสดงผล (Error Boundary Caught)</p>
                                <pre className="bg-gray-100 p-4 rounded text-xs text-left overflow-auto mb-6 text-red-800">
                                    {this.state.error && this.state.error.toString()}
                                </pre>
                                <button onClick={() => window.location.reload()} className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    รีโหลดหน้าเว็บ
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [keyInput, setKeyInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = () => {
                if (!keyInput.trim()) return alert("กรุณาใส่ API Key");
                setIsLoading(true);
                // Fake validation delay
                setTimeout(() => {
                    onLogin(keyInput);
                    setIsLoading(false);
                }, 500);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div className="glass-card max-w-md w-full p-8 rounded-3xl animate-enter text-center">
                        <div className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-200 text-white">
                            <Icons.Lock />
                        </div>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">เข้าสู่ระบบผู้เชี่ยวชาญ</h1>
                        <p className="text-gray-500 mb-8">กรุณาใส่ Gemini API Key เพื่อเริ่มใช้งาน</p>
                        
                        <div className="space-y-4">
                            <div className="relative text-left">
                                <div className="absolute left-4 top-3.5 text-gray-400">
                                    <Icons.Key />
                                </div>
                                <input 
                                    type="password" 
                                    placeholder="วาง API Key ที่นี่ (AIzaSy...)" 
                                    className="w-full pl-12 pr-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                    value={keyInput}
                                    onChange={(e) => setKeyInput(e.target.value)}
                                />
                            </div>
                            <button 
                                onClick={handleLogin}
                                disabled={isLoading}
                                className="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold shadow-lg shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                {isLoading ? "กำลังตรวจสอบ..." : "เข้าใช้งานระบบ"} 
                                {!isLoading && <Icons.ArrowRight />}
                            </button>
                        </div>
                        <div className="mt-6 text-xs text-gray-400">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 hover:underline">ขอ API Key ฟรีที่นี่ (Google AI Studio)</a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const MainApp = ({ apiKey, onLogout }) => {
            const [fileContent, setFileContent] = useState("");
            const [fileName, setFileName] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [result, setResult] = useState(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                
                const reader = new FileReader();
                if (file.name.endsWith('.docx')) {
                    reader.onload = (evt) => {
                        if (window.mammoth) {
                            window.mammoth.extractRawText({ arrayBuffer: evt.target.result })
                                .then((res) => setFileContent(res.value))
                                .catch(err => alert("อ่านไฟล์ DOCX ไม่ได้: " + err.message));
                        } else {
                            alert("ระบบอ่าน DOCX ยังไม่พร้อม (Library Loading)");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.onload = (evt) => setFileContent(evt.target.result);
                    reader.readAsText(file);
                }
            };

            const startGrading = async () => {
                if (!fileContent) return alert("กรุณาอัปโหลดไฟล์ก่อน");
                setIsAnalyzing(true);
                setResult(null);

                try {
                    const prompt = `
                        ${EXPERT_CONTEXT}
                        
                        นี่คือการบ้านนักศึกษา: "${fileContent.substring(0, 8000)}" 
                        
                        ให้ตอบเป็น JSON เท่านั้น Format:
                        {
                            "score": number,
                            "grade": "String",
                            "summary": "String",
                            "details": [
                                { "point": "ชื่อหัวข้อ", "status": "correct หรือ incorrect หรือ partial", "comment": "คำอธิบาย" }
                            ],
                            "expert_tip": "ข้อแนะนำ"
                        }
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "API Error");
                    }
                    
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0].content) throw new Error("No content returned");
                    
                    const text = data.candidates[0].content.parts[0].text;
                    setResult(JSON.parse(text));

                } catch (error) {
                    alert("เกิดข้อผิดพลาด: " + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col animate-enter">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                <Icons.BookOpen />
                            </div>
                            <div>
                                <h1 className="font-bold text-gray-800 text-lg">SE Grader <span className="text-indigo-600">Expert</span></h1>
                            </div>
                        </div>
                        <button onClick={onLogout} className="text-sm text-gray-500 hover:text-red-500 flex items-center gap-2">
                            <Icons.LogOut /> ออกจากระบบ
                        </button>
                    </header>

                    {/* Content Grid */}
                    <main className="flex-1 max-w-6xl w-full mx-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        {/* Left: Input */}
                        <div className="flex flex-col gap-6">
                            <div className="glass-card p-6 rounded-3xl">
                                <h2 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <div className="text-blue-600"><Icons.FileText /></div>
                                    ข้อมูลการบ้าน
                                </h2>
                                
                                <div className="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer relative group">
                                    <input type="file" onChange={handleFileUpload} accept=".docx,.txt" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 group-hover:scale-110 transition-transform">
                                        <Icons.UploadCloud />
                                    </div>
                                    <p className="text-gray-600 font-medium truncate px-4">
                                        {fileName ? fileName : "คลิกอัปโหลดไฟล์ .docx หรือ .txt"}
                                    </p>
                                </div>

                                {fileContent && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-xs font-bold text-gray-500 uppercase">Preview</span>
                                            <span className="text-xs text-gray-400">{fileContent.length} chars</span>
                                        </div>
                                        <div className="text-sm text-gray-600 h-32 overflow-y-auto font-mono bg-white p-3 rounded-lg border border-gray-100 custom-scroll">
                                            {fileContent}
                                        </div>
                                    </div>
                                )}

                                <button 
                                    onClick={startGrading}
                                    disabled={isAnalyzing || !fileContent}
                                    className={`mt-6 w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all flex justify-center items-center gap-3
                                        ${isAnalyzing || !fileContent ? 'bg-gray-300 cursor-not-allowed shadow-none' : 'bg-gradient-to-r from-blue-600 to-indigo-600 shadow-blue-200 hover:-translate-y-1'}`}
                                >
                                    {isAnalyzing ? (
                                        <><div className="text-white"><Icons.Loader2 /></div> กำลังตรวจ...</>
                                    ) : (
                                        <><Icons.Sparkles /> เริ่มตรวจด้วย AI</>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Right: Result */}
                        <div className="h-full">
                            {result ? (
                                <div className="glass-card h-full rounded-3xl flex flex-col overflow-hidden animate-enter">
                                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="opacity-80 mb-1">ผลการประเมิน</p>
                                                <h2 className="text-3xl font-bold">เกรด {result.grade}</h2>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-5xl font-black">{result.score}</div>
                                                <div className="text-xs opacity-70">คะแนนเต็ม 100</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="p-6 flex-1 overflow-y-auto custom-scroll" style={{maxHeight: '600px'}}>
                                        <div className="mb-6">
                                            <h4 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                                <div className="text-indigo-500"><Icons.Activity /></div>
                                                บทสรุปจาก AI
                                            </h4>
                                            <p className="text-gray-600 text-sm leading-relaxed bg-gray-50 p-4 rounded-xl border border-gray-100">
                                                {result.summary}
                                            </p>
                                        </div>

                                        <div className="space-y-4">
                                            {result.details && result.details.map((item, idx) => (
                                                <div key={idx} className="flex gap-4 p-4 rounded-xl border border-gray-100 hover:shadow-md transition-shadow bg-white">
                                                    <div className={`mt-1 flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                                                        ${item.status === 'correct' ? 'bg-green-100 text-green-600' : 
                                                          item.status === 'incorrect' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'}`}>
                                                        {item.status === 'correct' ? <Icons.Check /> : item.status === 'incorrect' ? <Icons.X /> : <Icons.AlertCircle />}
                                                    </div>
                                                    <div>
                                                        <h5 className="font-bold text-gray-800 text-sm">{item.point}</h5>
                                                        <p className="text-sm text-gray-500 mt-1">{item.comment}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="mt-8 bg-blue-50 border border-blue-100 p-5 rounded-2xl">
                                            <h4 className="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2">
                                                <Icons.Lightbulb /> Expert Tip
                                            </h4>
                                            <p className="text-sm text-blue-700 italic">"{result.expert_tip}"</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-card h-full rounded-3xl flex flex-col items-center justify-center p-10 text-center text-gray-400 border-dashed border-2 border-gray-300 bg-gray-50/50">
                                    <div className="bg-white p-6 rounded-full shadow-sm mb-4">
                                        <Icons.FileText />
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-500">รอผลการตรวจสอบ</h3>
                                    <p className="text-sm max-w-xs mt-2">
                                        อัปโหลดไฟล์งานทางด้านซ้าย แล้วกดปุ่ม "เริ่มตรวจด้วย AI"
                                    </p>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // --- Root App ---
        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem("se_grader_key_v2") || "");
            const [isLoggedIn, setIsLoggedIn] = useState(!!localStorage.getItem("se_grader_key_v2"));

            const handleLogin = (key) => {
                localStorage.setItem("se_grader_key_v2", key);
                setApiKey(key);
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                localStorage.removeItem("se_grader_key_v2");
                setApiKey("");
                setIsLoggedIn(false);
            };

            return (
                <ErrorBoundary>
                    {isLoggedIn ? <MainApp apiKey={apiKey} onLogout={handleLogout} /> : <LoginScreen onLogin={handleLogin} />}
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

