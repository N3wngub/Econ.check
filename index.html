<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SE Grader Pro - ระบบตรวจการบ้านที่เสถียรยิ่งขึ้น</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mammoth.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Knowledge Base (เนื้อหาจากหนังสือเรียน) ---
        const PDF_CONTEXT = `
            บทที่ 6 การคิดค่าใช้จ่ายในการพัฒนาซอฟต์แวร์ (Software Cost Estimation Model)
            1. COCOMO Model (Constructive Cost Model):
               - Organic (งานง่าย): a=2.4, b=1.05, c=2.5, d=0.38
               - Semi-detached (งานกลาง): a=3.0, b=1.12, c=2.5, d=0.35
               - Embedded (งานยาก): a=3.6, b=1.20, c=2.5, d=0.32
               - สูตร Effort (คน-เดือน) = a * (KLOC)^b
               - สูตร Time (เดือน) = c * (Effort)^d
               - สูตร People (คน) = Effort / Time
            2. Halstead's Theory:
               - N (Length) = N1 + N2
               - N_hat (Estimated) = u1*log2(u1) + u2*log2(u2)
        `;

        // --- Mock Responses (กรณี API พัง) ---
        const MOCK_RESULTS = [
            {
                score: 92, grade: "A", summary: "ยอดเยี่ยม! การเลือกใช้สูตร COCOMO แบบ Semi-detached ถูกต้องและคำนวณแม่นยำ",
                feedback: [
                    { topic: "การเลือก Model", status: "correct", comment: "เลือก Semi-detached ได้ถูกต้องตามโจทย์ (ขนาด 33.3 KLOC)" },
                    { topic: "การคำนวณ Effort", status: "correct", comment: "คำนวณได้ 152.09 คน-เดือน ถูกต้อง" },
                    { topic: "การคำนวณ Time", status: "partial", comment: "ผลลัพธ์ถูกต้อง แต่ควรแสดงทศนิยม 2 ตำแหน่งให้ชัดเจนกว่านี้" }
                ],
                suggestion: "ลองเพิ่มการอธิบายความหมายของตัวแปร a, b, c, d เพื่อความสมบูรณ์ยิ่งขึ้น"
            },
            {
                score: 75, grade: "B", summary: "ทำได้ดี แต่มีการเลือกค่าคงที่ผิดพลาดเล็กน้อยในส่วนของ Embedded Model",
                feedback: [
                    { topic: "การเลือก Model", status: "incorrect", comment: "โจทย์ระบุว่าซับซ้อนมาก ควรใช้ Embedded (a=3.6) แต่คุณใช้ Semi-detached" },
                    { topic: "การคำนวณ", status: "correct", comment: "กระบวนการคำนวณถูกต้องตามสูตรที่เลือกมา" },
                ],
                suggestion: "กลับไปทบทวนตารางค่าคงที่ a, b, c, d ในหน้า 65 ของหนังสือเรียนอีกครั้ง"
            }
        ];

        // --- Components ---
        const Icon = ({ name, className = "" }) => {
            return <i data-lucide={name} className={className}></i>;
        };

        const App = () => {
            const [apiKey, setApiKey] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const [content, setContent] = useState("");
            const [isGrading, setIsGrading] = useState(false);
            const [result, setResult] = useState(null);
            const [errorMsg, setErrorMsg] = useState("");
            const [useMock, setUseMock] = useState(false); // Force Demo Mode

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
                // Load API Key from localStorage if available
                const savedKey = localStorage.getItem("gemini_api_key");
                if (savedKey) setApiKey(savedKey);
            }, [result, showSettings]);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem("gemini_api_key", key);
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.name.endsWith('.docx')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        mammoth.extractRawText({ arrayBuffer: evt.target.result })
                            .then((res) => setContent(res.value))
                            .catch(err => setErrorMsg("อ่านไฟล์ DOCX ไม่สำเร็จ: " + err.message));
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => setContent(evt.target.result);
                    reader.readAsText(file);
                } else {
                    setErrorMsg("รองรับเฉพาะไฟล์ .docx และ .txt");
                }
            };

            const gradeHomework = async () => {
                if (!content.trim()) {
                    setErrorMsg("กรุณาใส่เนื้อหาการบ้านก่อนตรวจ");
                    return;
                }
                
                // Reset State
                setIsGrading(true);
                setResult(null);
                setErrorMsg("");

                // Fallback to Mock immediately if specified
                if (useMock || !apiKey) {
                    console.log("Using Demo Mode (No API Key or Mock forced)");
                    setTimeout(() => {
                        const randomResult = MOCK_RESULTS[Math.floor(Math.random() * MOCK_RESULTS.length)];
                        setResult(randomResult);
                        setIsGrading(false);
                    }, 1500);
                    return;
                }

                // Real API Call
                try {
                    const prompt = `
                        Context: ${PDF_CONTEXT}
                        Student Answer: "${content.substring(0, 2000)}"
                        Task: Grade this software engineering homework based on the context. Check COCOMO calculations specifically.
                        Output JSON only: {"score": number, "grade": "string", "summary": "string", "feedback": [{"topic": "string", "status": "correct/incorrect/partial", "comment": "string"}], "suggestion": "string"}
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || "API Connect Failed");
                    }

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    setResult(JSON.parse(resultText));

                } catch (error) {
                    console.error("Grading Error:", error);
                    setErrorMsg(`เกิดข้อผิดพลาด: ${error.message} (ระบบสลับไปใช้โหมด Demo ชั่วคราว)`);
                    // Auto fallback on error
                    setResult(MOCK_RESULTS[0]);
                } finally {
                    setIsGrading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-8">
                    
                    {/* Top Bar */}
                    <div className="w-full max-w-5xl flex justify-between items-center mb-8">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                <Icon name="graduation-cap" className="w-8 h-8" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">SE Grader Pro</h1>
                                <p className="text-xs text-gray-500">ระบบตรวจการบ้านอัจฉริยะ (บทที่ 6)</p>
                            </div>
                        </div>
                        <button 
                            onClick={() => setShowSettings(!showSettings)}
                            className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors"
                        >
                            <Icon name="settings" className="w-6 h-6" />
                        </button>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="w-full max-w-5xl mb-6 glass-panel rounded-xl p-6 border-l-4 border-indigo-500 animate-fade-in">
                            <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <Icon name="key" className="w-4 h-4" /> ตั้งค่าระบบ
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-sm text-gray-600 block mb-1">Google Gemini API Key</label>
                                    <input 
                                        type="password" 
                                        value={apiKey}
                                        onChange={(e) => saveApiKey(e.target.value)}
                                        placeholder="วาง API Key ที่นี่ (ถ้ามี)"
                                        className="w-full p-2 border rounded-lg text-sm"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">*ถ้าไม่ใส่ ระบบจะใช้โหมด Demo (สุ่มผลลัพธ์)</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="checkbox" 
                                        id="mockMode" 
                                        checked={useMock} 
                                        onChange={(e) => setUseMock(e.target.checked)}
                                        className="w-4 h-4 text-indigo-600 rounded"
                                    />
                                    <label htmlFor="mockMode" className="text-sm text-gray-700">
                                        บังคับใช้โหมด Demo (ไม่ต่อเน็ต)
                                    </label>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        {/* Left: Input */}
                        <div className="flex flex-col gap-4">
                            <div className="glass-panel rounded-2xl p-6 flex flex-col h-[600px]">
                                <div className="flex justify-between mb-4">
                                    <h2 className="font-bold text-gray-700 flex items-center gap-2">
                                        <Icon name="file-text" className="w-5 h-5" /> ต้นฉบับการบ้าน
                                    </h2>
                                    <div className="relative">
                                        <input type="file" id="file" onChange={handleFileUpload} className="hidden" accept=".docx,.txt" />
                                        <label htmlFor="file" className="cursor-pointer text-xs font-medium bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg text-gray-600 flex items-center gap-1 transition-colors">
                                            <Icon name="upload" className="w-3 h-3" /> อัปโหลดไฟล์
                                        </label>
                                    </div>
                                </div>
                                
                                <textarea 
                                    className="flex-1 w-full p-4 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-200 resize-none text-sm leading-relaxed"
                                    placeholder="วางคำตอบของนักศึกษาที่นี่ หรืออัปโหลดไฟล์..."
                                    value={content}
                                    onChange={(e) => setContent(e.target.value)}
                                ></textarea>

                                {errorMsg && (
                                    <div className="mt-3 text-xs text-red-500 bg-red-50 p-2 rounded border border-red-100 flex gap-2 items-center">
                                        <Icon name="alert-circle" className="w-4 h-4" /> {errorMsg}
                                    </div>
                                )}

                                <button 
                                    onClick={gradeHomework}
                                    disabled={isGrading}
                                    className={`mt-4 w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all flex justify-center items-center gap-2 
                                        ${isGrading ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:scale-[1.02] active:scale-95'}`}
                                >
                                    {isGrading ? (
                                        <><span className="animate-spin mr-2">⟳</span> กำลังวิเคราะห์...</>
                                    ) : (
                                        <><Icon name="check-circle" className="w-5 h-5" /> ตรวจให้คะแนน</>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Right: Output */}
                        <div className="glass-panel rounded-2xl p-6 h-[600px] overflow-y-auto custom-scrollbar bg-gray-50/50">
                            {result ? (
                                <div className="animate-fade-in">
                                    <div className="flex justify-between items-start mb-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <div>
                                            <p className="text-sm text-gray-500 mb-1">เกรดที่ได้</p>
                                            <div className={`text-6xl font-black ${
                                                result.grade === 'A' ? 'text-green-500' : 
                                                result.grade === 'B' ? 'text-blue-500' : 
                                                'text-yellow-500'
                                            }`}>
                                                {result.grade}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm text-gray-500 mb-1">คะแนนรวม</p>
                                            <div className="text-4xl font-bold text-gray-800">{result.score}/100</div>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                                            <h4 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                                <Icon name="bar-chart-2" className="w-4 h-4 text-indigo-500" /> บทสรุป
                                            </h4>
                                            <p className="text-sm text-gray-600 leading-relaxed">{result.summary}</p>
                                        </div>

                                        {result.feedback.map((item, idx) => (
                                            <div key={idx} className={`p-4 rounded-xl border-l-4 bg-white shadow-sm ${
                                                item.status === 'correct' ? 'border-green-500' :
                                                item.status === 'incorrect' ? 'border-red-500' :
                                                'border-yellow-500'
                                            }`}>
                                                <div className="flex items-center justify-between mb-1">
                                                    <span className="font-bold text-sm text-gray-700">{item.topic}</span>
                                                    {item.status === 'correct' && <Icon name="check" className="w-4 h-4 text-green-500" />}
                                                    {item.status === 'incorrect' && <Icon name="x" className="w-4 h-4 text-red-500" />}
                                                    {item.status === 'partial' && <Icon name="alert-triangle" className="w-4 h-4 text-yellow-500" />}
                                                </div>
                                                <p className="text-sm text-gray-500">{item.comment}</p>
                                            </div>
                                        ))}
                                        
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-4">
                                            <h4 className="text-xs font-bold text-blue-700 uppercase mb-2">ข้อเสนอแนะเพิ่มเติม</h4>
                                            <p className="text-sm text-blue-800">{result.suggestion}</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                                    <div className="bg-gray-200 p-4 rounded-full mb-4">
                                        <Icon name="search" className="w-8 h-8 text-gray-400" />
                                    </div>
                                    <p>รอผลการตรวจสอบ...</p>
                                </div>
                            )}
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

